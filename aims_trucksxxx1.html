<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Portal</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        form {
            display: flex;
            flex-direction: column;
            width: 300px;
            margin: auto;
        }
        label {
            margin-bottom: 5px;
        }
        input {
            margin-bottom: 10px;
        }
        button {
            width: 100px;
            padding: 5px;
        }
        table {
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        header {
            background-color: #4CAF50; /* Green */
            padding: 10px;
            text-align: center;
            font-size: 24px;
            color: white;
            position: fixed; /* Fix position */
            width: 100%; /* Full width */
            top: 0; /* At the top */
            z-index: 1000; /* Ensure it's above other elements */
        }
        body {
            padding-top: 50px; /* Adjusted space for the header */
        }
    </style>
</head>
<body>
        <header>
        Truck Portal
        </header>
    <form id="projectForm">

        <label>Date of works: <input type="date" id="dateOfWorks"></label>
        <label>Project No: <input type="text" id="projectNo"></label>
        <label>DRSID: <input type="text" id="drsid"></label>
        <label>Project name: <input type="text" id="projectName"></label>
        <label>Location: <input type="text" id="location"></label>
        <label>Supervisor: 
        <input list="supervisors" type="text" id="supervisor">
    <datalist id="supervisors">
        <option value="Andrew Jones - 0401 896 458">
        <option value="Chris Henley - 0409 047 383">
        <option value="Craig Philipson - 0401 894 926">
        <option value="Dean Cullen-Reid - 0401 895 407">
        <option value="Ian Kirby - 0401 897 523">
        <option value="James Laurenson - 0401 894 898">
        <option value="Johnny Cash - 0437 821 140">
        <option value="Mal Wringe - 0401 896 287">
        <option value="Mark Chalker - 0401 892 260">
        <option value="Mark Knowlan - 0419 742 437">
        <option value="Matt (Red) Hocking - 0401 892 201">
        <option value="Matt Dillon - 0417 455 094">
        <option value="Matt Egan - 0401 892 277">
        <option value="Neel Patel - 0401 893 372">
        <option value="Raj Modi - 0401 893 372">
        <option value="Steve Cuthbertson - 0401 897 477">
        <option value="T300 Mobile - 0401 896 982">
        <option value="Tony (Ribsy) Carlyle  - 0401 895 461">
        <option value="Troy Kennington - 0401 897 571">
        <option value="Yannik Gintrac - 0422 200 404">
    </datalist>
</label>

        <!-- ... Previous code ... -->

<label>Carter company: 
    <input list="carterCompanies" type="text" id="carterCompany">
    <datalist id="carterCompanies">
        <option value="ACE">
        <option value="ACCURATE">
        <option value="AGGI REVOLUTIONS">
        <option value="AGIT-8">
        <option value="AL">
        <option value="ALLABOUT">
        <option value="ASJJ">
        <option value="BAQ">
        <option value="BAZELEY">
        <option value="BIG DAVES">
        <option value="BITU-MILL">
        <option value="BLACKSTARK">
        <option value="BLUE TIPPERS">
        <option value="BRAD RICHARDSON">
        <option value="BRENT">
        <option value="BRUCE">
        <option value="COASTAL">
        <option value="COLAS">
        <option value="D & M PLANT">
        <option value="DIRT-TEC">
        <option value="EASTCOAST">
        <option value="EASY TIPPERS">
        <option value="EDGERTON">
        <option value="F&D TIPPERS">
        <option value="GA TRANSPORT">
        <option value="GAINSCOUT">
        <option value="GINTRAC">
        <option value="GRAHAM">
        <option value="GRINGO">
        <option value="JASMOND">
        <option value="JAT">
        <option value="KELLYS">
        <option value="LJH TRANSPORT">
        <option value="Moving Earth">
        <option value="NEHO">
        <option value="NQ2U">
        <option value="PAUL">
        <option value="PETROB">
        <option value="PICKLES">
        <option value="PLATINUM">
        <option value="PRIDDEY">
        <option value="RACEWISH">
        <option value="RODDERS">
        <option value="SCHMIEDE">
        <option value="SOLE">
        <option value="SS TIPPERS">
        <option value="STRUCTURAL">
        <option value="SUB HAULAGE">
        <option value="SUNSHINE CIVIL">
        <option value="SWARLY">
        <option value="TOM">
        <option value="WESTERN LS">
        <option value="WINTER">
    </datalist>
</label>

<label>Tons: 
    <input type="number" id="tons">
</label>

<button type="button" onclick="generateTrucks()">Generate</button>

<label>Use Favorite Truck Companies: 
    <input type="checkbox" id="useFavorites">
</label>


<p id="generatedTrucks"></p>

<!-- ... Remaining code ... -->

        <label>Truck Size: <input type="text" id="truckSize"></label>
        <label>Start Time: <input type="time" id="startTime"></label>
        <label>Time Increment (mins): <input type="number" id="timeIncrement" value="5"></label>
        <label>Starting Point: <input type="text" id="startingPoint"></label>
        <label>Booking Status: <input type="text" id="bookingStatus"></label>
        <button type="button" onclick="addEntry()">Add Entry</button>
        <button type="button" onclick="exportToExcel()">Export to Excel</button>
    </form>
    <button type="button" onclick="sortTable()">Sort by Project No</button>
    <button type="button" onclick="sortTableByDate()">Sort by Date</button>
    <button type="button" onclick="sortTableByProjectNoAndDate()">Sort by Project No and Date</button>


    <input type="file" id="upload" accept=".xlsx" onchange="handleFileUpload()" />


    <table id="entriesTable">
        <tr>
        <th>Project No</th>
        <th>Date</th>
        <th>Carter Company</th>
        <th>Truck Size</th>
        <th>Start Time</th>
        <th>Starting Point</th>
        <th>Booking Status</th>
        <th>Action</th>
        </tr>
        <!-- Entries will be added here dynamically -->
    </table>
    <script>

const entries = [];

function addEntry(projectNo, dateOfWorks, carterCompany, truckSize, startTime, startingPoint, bookingStatus) {
    // If parameters are not provided, get values from input fields
    projectNo = projectNo || document.getElementById('projectNo').value;
    dateOfWorks = dateOfWorks || document.getElementById('dateOfWorks').value;
    carterCompany = carterCompany || document.getElementById('carterCompany').value;
    truckSize = truckSize || document.getElementById('truckSize').value;
    startTime = startTime || document.getElementById('startTime').value;
    startingPoint = startingPoint || document.getElementById('startingPoint').value;
    bookingStatus = bookingStatus || document.getElementById('bookingStatus').value;

    const entry = [projectNo, dateOfWorks, carterCompany, truckSize, startTime, startingPoint, bookingStatus];
    entries.push(entry);

    const table = document.getElementById('entriesTable');
    const newRow = table.insertRow(-1);

    entry.forEach((text, index) => {
        const newCell = newRow.insertCell(-1);
        const newInput = document.createElement('input');
        newInput.value = text;
        newInput.dataset.index = index; // Store the index to know which entry to update
        newInput.oninput = function() {
            // Update the entry in the entries array when the input value changes
            entries[newRow.rowIndex-1][this.dataset.index] = this.value;
        };
        newCell.appendChild(newInput);
    });

    // Action cell
    const actionCell = newRow.insertCell(-1);

    // Delete button
    const deleteButton = document.createElement("button");
    deleteButton.textContent = "Delete";
    deleteButton.onclick = function() {
        table.deleteRow(newRow.rowIndex);
        entries.splice(newRow.rowIndex-1, 1);
    };
    actionCell.appendChild(deleteButton);

    // Update button
    const updateButton = document.createElement("button");
    updateButton.textContent = "Revise";
    updateButton.onclick = function() {
        newRow.cells[6].firstChild.value = "Revised"; // Update the input value
        entries[newRow.rowIndex-1][6] = "Revised"; // Update the entry in the entries array
    };
    actionCell.appendChild(updateButton);
}


function exportToExcel() {
    const dateOfWorks = document.getElementById('dateOfWorks').value;
    const projectNo = document.getElementById('projectNo').value;
    const drsid = document.getElementById('drsid').value;
    const projectName = document.getElementById('projectName').value;
    const location = document.getElementById('location').value;
    const supervisor = document.getElementById('supervisor').value;

    const wb = XLSX.utils.book_new();

    // Group entries by date
    const groupedEntries = entries.reduce((acc, entry) => {
        (acc[entry[1]] = acc[entry[1]] || []).push(entry);
        return acc;
    }, {});

    Object.keys(groupedEntries).forEach(date => {
        const data = [
            ["BOOKING STATUS / CARTER MISSMATCH",,,,,],
            ["Date of works:", date + " NIGHT",,,],
            ["Project No:", projectNo,,"DRSID:", drsid],
            ["Project:", projectName,,,],
            ["Location", location,,,],
            ["Supervisor:", supervisor,,,],
            ["Project No", "Date", "Carter:", "Truck Size:", "Start Time:", "Starting Point:", "Booking Status:"],
        ];

        // Add entries to the data array before exporting to Excel
        groupedEntries[date].forEach(entry => {
            data.push(entry);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, date); // Use date as sheet name
    });

    XLSX.writeFile(wb, "project_data.xlsx");
}

function handleFileUpload() {
    const input = document.getElementById('upload');
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = e.target.result;
        const workbook = XLSX.read(data, {
            type: 'binary'
        });

        // Clear existing entries
        entries.length = 0;
        const existingTables = document.querySelectorAll('.entriesTable');
        existingTables.forEach(table => table.remove());

workbook.SheetNames.forEach(sheetName => {
    // Create a new table for each sheet
    const table = document.createElement('table');
    table.classList.add('entriesTable');
    document.body.appendChild(table);

    const sheet = workbook.Sheets[sheetName];

    // Assuming project name and location are in B3 and B5 respectively
    const projectName = sheet['B3'] ? sheet['B3'].v : "Unknown Project";
    const location = sheet['B5'] ? sheet['B5'].v : "Unknown Location";

    // Calculate total tons by summing all numbers in column D starting from row 8
    let totalTons = 0;
    let row = 8; // Starting from row 8
    while(sheet['D' + row]) {
        totalTons += sheet['D' + row].v;
        row++;
    }

    // Add a header to the table to indicate the sheet name and additional info
    const headerRow = table.insertRow(-1);
    const headerCell = headerRow.insertCell(-1);
    headerCell.colSpan = 8;
    headerCell.textContent = `Sheet: ${sheetName}, Project: ${projectName}, Location: ${location}, Total Tons: ${totalTons}`;
    headerCell.style.backgroundColor = '#4CAF50'; // Green background
    headerCell.style.color = 'white'; // White text
    headerCell.style.textAlign = 'center';
    headerCell.style.fontSize = '18px'; // Larger font size
    headerCell.style.padding = '10px'; // Some padding

            // Add column headers to the table
            const columnHeaders = ["Project No", "Date", "Carter Company", "Truck Size", "Start Time", "Starting Point", "Booking Status", "Action"];
            const columnHeadersRow = table.insertRow(-1);
            columnHeaders.forEach(header => {
                const cell = columnHeadersRow.insertCell(-1);
                cell.textContent = header;
                cell.style.backgroundColor = '#ddd';
            });

            const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});

            // Assuming the header is in the first row, data starts from the second row
            jsonData.slice(7).forEach(([
                projectNo, 
                dateOfWorks, 
                carterCompany, 
                truckSize, 
                startTime, 
                startingPoint, 
                bookingStatus
            ]) => {
                // Add to entries array
                entries.push([
                    projectNo, 
                    dateOfWorks, 
                    carterCompany, 
                    truckSize, 
                    startTime, 
                    startingPoint, 
                    bookingStatus
                ]);

                // Add to table
                const newRow = table.insertRow(-1);
                [projectNo, dateOfWorks, carterCompany, truckSize, startTime, startingPoint, bookingStatus].forEach(text => {
                    const newCell = newRow.insertCell(-1);
                    const newText = document.createTextNode(text);
                    newCell.appendChild(newText);
                });

                // Action cell
                const actionCell = newRow.insertCell(-1);

                // Delete button
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.onclick = function() {
                    table.deleteRow(newRow.rowIndex);
                    entries.splice(newRow.rowIndex-1, 1);
                };
                actionCell.appendChild(deleteButton);

                // Update button
                const updateButton = document.createElement("button");
                updateButton.textContent = "Revise";
                updateButton.onclick = function() {
                    newRow.cells[6].textContent = "Revised";
                    entries[newRow.rowIndex-1][6] = "Revised";
                };
                actionCell.appendChild(updateButton);
            });
        });
    };
    reader.readAsBinaryString(input.files[0]);
}






function addMinutesToTime(time, minsToAdd) {
    const [hours, minutes] = time.split(':').map(Number);
    let newMinutes = minutes + minsToAdd;
    let newHours = hours + Math.floor(newMinutes / 60);
    newMinutes = newMinutes % 60;
    return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
}

function sortTableByDate() {
    const table = document.getElementById('entriesTable');
    let rows, switching, i, x, y, shouldSwitch;
    switching = true;

    // Continue looping until no switching is needed
    while (switching) {
        switching = false;
        rows = table.rows;

        // Loop through all table rows (except the first, which contains table headers)
        for (i = 1; i < (rows.length - 1); i++) {
            shouldSwitch = false;

            // Get the two elements you want to compare: dates
            const dateX = new Date(rows[i].getElementsByTagName("TD")[1].innerHTML);
            const dateY = new Date(rows[i + 1].getElementsByTagName("TD")[1].innerHTML);

            // Check if the two rows should switch place based on date
            if (dateX > dateY) {
                shouldSwitch = true;
                break;
            }
        }
        if (shouldSwitch) {
            // If a switch has been marked, make the switch and mark that a switch has been done
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
        }
    }
}



function sortTable() {
    const table = document.getElementById('entriesTable');
    let rows, switching, i, x, y, shouldSwitch;
    switching = true;

    // Continue looping until no switching is needed
    while (switching) {
        switching = false;
        rows = table.rows;

        // Loop through all table rows (except the first, which contains table headers)
        for (i = 1; i < (rows.length - 1); i++) {
            shouldSwitch = false;

            // Get the two elements you want to compare: project number and date
            const projectNoX = rows[i].getElementsByTagName("TD")[0].innerHTML;
            const projectNoY = rows[i + 1].getElementsByTagName("TD")[0].innerHTML;
            const dateX = new Date(rows[i].getElementsByTagName("TD")[1].innerHTML);
            const dateY = new Date(rows[i + 1].getElementsByTagName("TD")[1].innerHTML);

            // Check if the two rows should switch place based on project number
            if (projectNoX.toLowerCase() > projectNoY.toLowerCase()) {
                shouldSwitch = true;
                break;
            }
            
            // If project numbers are the same, check based on date
            if (projectNoX.toLowerCase() === projectNoY.toLowerCase() && dateX > dateY) {
                shouldSwitch = true;
                break;
            }
        }
        if (shouldSwitch) {
            // If a switch has been marked, make the switch and mark that a switch has been done
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
        }
    }
}



function generateTrucks() {
    const tons = parseInt(document.getElementById('tons').value);
    const truckSizes = [12, 15, 17, 18, 24];
    let remainingTons = tons;
    let generatedTrucks = [];
    let maxIterations = 1000;
    let currentIteration = 0;

    while (remainingTons > 0 && currentIteration < maxIterations) {
        const randomIndex = Math.floor(Math.random() * truckSizes.length);
        const selectedTruckSize = truckSizes[randomIndex];

        if (selectedTruckSize <= remainingTons) {
            generatedTrucks.push(selectedTruckSize);
            remainingTons -= selectedTruckSize;
        }

        currentIteration++;
    }

    if (currentIteration === maxIterations) {
        alert('There was an Error, I am Fixing this just keep pressing the button it will work.');
        return;
    }

    const totalTons = generatedTrucks.reduce((sum, truckSize) => sum + truckSize, 0);
    if (Math.abs(totalTons - tons) > 10) {
        alert('Unable to generate trucks within ±10t of the specified value. Please try a different value.');
        return;
    }

    const projectNo = document.getElementById('projectNo').value;
    const dateOfWorks = document.getElementById('dateOfWorks').value;
    let currentTime = document.getElementById('startTime').value; // Changed to let because we'll modify it
    const startingPoint = document.getElementById('startingPoint').value;
    const bookingStatus = document.getElementById('bookingStatus').value;
    const timeIncrement = parseInt(document.getElementById('timeIncrement').value); // Added time increment

    if (!projectNo || !dateOfWorks || !currentTime || !startingPoint || !bookingStatus) {
        alert('Please fill in all details except Carter Company and Truck Size.');
        return;
    }

    const useFavorites = document.getElementById('useFavorites').checked;
    const favoriteCompanies = ['RODDERS', 'NEHO', 'BAZELEY', 'D & M PLANT', 'DIRT-TEC', 'AGGI REVOLUTIONS'];
    const carterCompanies = Array.from(document.getElementById('carterCompanies').options).map(option => option.value);

    const prioritizedCompanies = useFavorites ? 
        [...favoriteCompanies, ...carterCompanies.filter(company => !favoriteCompanies.includes(company.toLowerCase()))] : 
        carterCompanies;

    generatedTrucks.forEach(truckSize => {
        const randomIndex = Math.floor(Math.random() * prioritizedCompanies.length);
        const selectedCarterCompany = prioritizedCompanies[randomIndex];

        addEntry(projectNo, dateOfWorks, selectedCarterCompany, truckSize, currentTime, startingPoint, bookingStatus);

        // Increment the time for the next truck
        currentTime = addMinutesToTime(currentTime, timeIncrement);
    });
}



    </script>
</body>
</html>
